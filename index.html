<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whispers Online</title>
    <!-- Tailwind CSS for styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animation for fading in new secrets */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #6b7a63; /* Updated background color */
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-modal-fade-in {
            animation: modalFadeIn 0.3s ease-out forwards;
        }
        .toast {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-[#6b7a63] text-gray-100 font-sans p-4 flex flex-col items-center min-h-screen">

    <!-- User ID display for debugging and collaboration -->
    <div id="user-id-display" class="fixed top-2 right-2 text-xs text-gray-800 bg-white p-2 rounded-lg shadow-md z-50">
        User ID: N/A
    </div>

    <!-- Error/Success Toast Notification -->
    <div id="toast-message" class="toast fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg text-white font-medium z-50 hidden">
        <!-- Message will be displayed here -->
    </div>

    <div class="w-full max-w-4xl mx-auto my-8 p-6 bg-[#5b6a53] rounded-2xl shadow-2xl border border-[#7d8b74]">
        <div class="text-center mb-8">
            <p class="text-gray-200 text-lg">Share your secret anonymously with the world and see how others react.</p>
            <div id="whisper-count" class="mt-2 text-sm text-[#a5b29c]">
                ‚ú® 0 whispers shared so far
            </div>
        </div>

        <form id="confess-form" class="mb-8">
            <div class="relative">
                <textarea
                    id="secret-input"
                    class="w-full p-4 rounded-xl border-2 border-[#7d8b74] bg-[#4a5544] text-base text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 resize-none placeholder-gray-400"
                    placeholder="What's weighing on your heart? Share it anonymously..."
                    rows="4"
                    required
                    maxLength="500"
                ></textarea>
                <div id="char-counter" class="absolute bottom-2 right-2 text-xs text-[#a5b29c]">
                    0/500
                </div>
            </div>
            <button
                id="confess-button"
                type="submit"
                class="w-full mt-4 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-xl hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]"
            >
                ü§´ Confess Anonymously
            </button>
        </form>

        <!-- New Positive Thought Button -->
        <button
            id="show-thought-button"
            class="w-full mt-4 px-6 py-3 bg-[#7d8b74] text-gray-900 font-semibold rounded-xl hover:bg-[#8da081] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 shadow-lg transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center space-x-2"
            title="Click for a positive thought!"
        >
            <span class="text-xl">‚ú®</span>
            <span>Click for a Positive Thought</span>
            <span class="text-xl">‚ú®</span>
        </button>

        <div class="mb-6">
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-gray-200 to-gray-400 bg-clip-text text-transparent">
                Recent Whispers
            </h2>
            
            <!-- Loading state -->
            <div id="loading-state" class="text-center text-gray-300 py-12">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300 mr-2"></div>
                    <span class="text-xl font-medium">Connecting to whispers...</span>
                </div>
            </div>

            <div id="secrets-container" class="space-y-6 hidden">
                <!-- Secrets will be dynamically inserted here -->
            </div>

            <div id="empty-state" class="text-center text-[#a5b29c] py-12 hidden">
              <div class="text-6xl mb-4">ü§ê</div>
              <p class="text-xl">No secrets yet.</p>
              <p class="text-sm mt-2">Be the first to share your whisper!</p>
            </div>
        </div>

        <div class="text-center text-sm text-[#a5b29c] pt-6 border-t border-[#7d8b74]">
            <p>üí´ All whispers are anonymous and ephemeral</p>
            <p class="mt-1">Share your truth, find your peace</p>
        </div>
    </div>

    <!-- Positive Thought Modal -->
    <div id="positive-thought-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden animate-modal-fade-in">
        <div class="bg-[#5b6a53] p-8 rounded-2xl shadow-xl w-full max-w-md border border-[#7d8b74] relative">
            <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="text-center">
                <h3 class="text-2xl font-bold bg-gradient-to-r from-green-400 to-teal-400 bg-clip-text text-transparent mb-4">
                    A Positive Thought for You!
                </h3>
                <p id="thought-text" class="text-lg text-gray-200 italic">
                    <!-- Positive thought will be inserted here -->
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs (using v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, doc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables (provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
  apiKey: "AIzaSyCERwY9HmAAdbPiufATtci6PT-jwBEj0sM",
  authDomain: "whispers-online.firebaseapp.com",
  projectId: "whispers-online",
  storageBucket: "whispers-online.firebasestorage.app",
  messagingSenderId: "1010119542710",
  appId: "1:1010119542710:web:f90cadfd81aef85e9ee317",
 measurementId: "G-9FFR6SP6T0"
};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Firebase Initialization and Auth ---
        let app, db, auth;
        let userId = 'N/A';
        const collectionPath = `artifacts/${appId}/public/data/secrets`;

        // --- DOM Elements ---
        const userIdDisplay = document.getElementById('user-id-display');
        const toastElement = document.getElementById('toast-message');
        const confessButton = document.getElementById('confess-button');
        const confessForm = document.getElementById('confess-form');
        const secretInput = document.getElementById('secret-input');
        const secretsContainer = document.getElementById('secrets-container');
        const whisperCountElement = document.getElementById('whisper-count');
        const emptyStateElement = document.getElementById('empty-state');
        const loadingStateElement = document.getElementById('loading-state');
        const charCounterElement = document.getElementById('char-counter');
        const showThoughtButton = document.getElementById('show-thought-button');
        const positiveThoughtModal = document.getElementById('positive-thought-modal');
        const thoughtTextElement = document.getElementById('thought-text');
        const closeModalButton = document.getElementById('close-modal-button');

        // --- Data & Configuration ---
        const emotions = [
            { emoji: '‚ù§Ô∏è', label: 'Love' },
            { emoji: 'üòÇ', label: 'Laugh' },
            { emoji: 'üò¢', label: 'Sad' },
            { emoji: 'üôè', label: 'Care' },
            { emoji: 'üòÆ', label: 'Surprise' },
            { emoji: 'üëè', label: 'Clap' },
        ];

        const positiveThoughts = [
            "Believe you can and you're halfway there.",
            "The best way to predict the future is to create it.",
            "Your limitation‚Äîit's only your imagination.",
            "Push yourself, because no one else is going to do it for you.",
            "Great things never come from comfort zones.",
            "The future belongs to those who believe in the beauty of their dreams.",
            "Go the extra mile. It's never crowded.",
            "Success is not final, failure is not fatal: it is the courage to continue that counts.",
            "The only way to do great work is to love what you do.",
            "Don't wait for opportunity. Create it.",
            "What you get by achieving your goals is not as important as what you become by achieving your goals.",
        ];

        // --- Utility Functions ---
        const showToast = (message, type = 'info') => {
            let bgColorClass;
            if (type === 'error') {
                bgColorClass = 'bg-red-500';
            } else if (type === 'success') {
                bgColorClass = 'bg-green-500';
            } else {
                bgColorClass = 'bg-gray-700';
            }
            toastElement.textContent = message;
            toastElement.className = `toast fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg text-white font-medium z-50 ${bgColorClass}`;
            toastElement.classList.remove('hidden');

            setTimeout(() => {
                toastElement.classList.add('hidden');
            }, 3000);
        };

        const formatTime = (timestamp) => {
            const now = Date.now();
            const diff = now - timestamp;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        };

        // --- Rendering Logic ---
        const renderSecrets = (secrets) => {
            secretsContainer.innerHTML = '';
            whisperCountElement.textContent = `‚ú® ${secrets.length} whispers shared so far`;

            loadingStateElement.classList.add('hidden');
            secretsContainer.classList.remove('hidden');

            if (secrets.length === 0) {
                emptyStateElement.classList.remove('hidden');
            } else {
                emptyStateElement.classList.add('hidden');
                secrets.forEach((secret, index) => {
                    const secretElement = document.createElement('div');
                    secretElement.className = "group p-6 bg-[#5b6a53] rounded-xl shadow-lg border border-[#7d8b74] hover:shadow-xl transition-all duration-300 hover:scale-[1.01]";
                    secretElement.style.animationDelay = `${index * 0.1}s`;
                    secretElement.classList.add('animate-fade-in');
                    secretElement.dataset.secretId = secret.id;

                    const reactionButtonsHtml = emotions.map(emotion => {
                        const count = secret.reactions[emotion.label] || 0;
                        return `
                            <button
                                type="button"
                                data-emotion-label="${emotion.label}"
                                class="flex items-center px-3 py-2 rounded-full border border-[#7d8b74] bg-[#4a5544] text-gray-300 text-sm font-medium hover:bg-[#3d4538] transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-sm hover:shadow-md transform hover:scale-105 active:scale-95"
                                title="React with ${emotion.label}"
                            >
                                <span class="text-lg mr-2">${emotion.emoji}</span>
                                <span class="font-bold min-w-[20px] text-center">
                                    ${count}
                                </span>
                            </button>
                        `;
                    }).join('');

                    const totalReactions = Object.values(secret.reactions || {}).reduce((a, b) => a + b, 0);

                    secretElement.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <p class="text-lg text-gray-200 leading-relaxed flex-1 mr-4">
                                "${secret.secret}"
                            </p>
                            <span class="text-xs text-[#a5b29c] whitespace-nowrap">
                                ${formatTime(secret.timestamp)}
                            </span>
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center">
                            ${reactionButtonsHtml}
                        </div>
                        <div class="mt-3 text-center">
                            <span class="text-xs text-[#a5b29c]">
                                ${totalReactions} total reactions
                            </span>
                        </div>
                    `;
                    secretsContainer.appendChild(secretElement);
                });
            }
        };
        
        // --- Event Handlers ---
        const handleConfess = async (e) => {
            e.preventDefault();
            
            const newSecretText = secretInput.value.trim();
            if (newSecretText === '') {
                showToast('Please enter a secret to confess.', 'error');
                return;
            }

            if (!db || !auth || !auth.currentUser) {
                showToast('App is not connected. Please refresh.', 'error');
                return;
            }

            confessButton.disabled = true;
            confessButton.innerHTML = `<div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                Sharing...
            </div>`;

            try {
                const newSecretObj = {
                    secret: newSecretText,
                    reactions: emotions.reduce((acc, emotion) => ({ ...acc, [emotion.label]: 0 }), {}),
                    timestamp: new Date(),
                };
                
                await addDoc(collection(db, collectionPath), newSecretObj);
                
                secretInput.value = '';
                showToast('Your secret has been shared!', 'success');
            } catch (error) {
                console.error("Error writing document: ", error);
                showToast('Failed to share secret. Please try again.', 'error');
            } finally {
                confessButton.disabled = false;
                confessButton.innerHTML = `ü§´ Confess Anonymously`;
                charCounterElement.textContent = '0/500';
            }
        };

        const handleReaction = async (e) => {
            const button = e.target.closest('[data-emotion-label]');
            if (!button) return;

            // FIX: Changed from data-emotion-label to emotionLabel
            const emotionLabel = button.dataset.emotionLabel;
            const secretCard = button.closest('[data-secret-id]');
            const secretId = secretCard.dataset.secretId;
            
            if (!db || !auth || !auth.currentUser) {
                showToast('App is not connected. Please refresh.', 'error');
                return;
            }
            const docRef = doc(db, collectionPath, secretId);

            try {
                await runTransaction(db, async (transaction) => {
                    const secretDoc = await transaction.get(docRef);
                    if (!secretDoc.exists()) {
                        throw "Document does not exist!";
                    }
                    const newReactions = { ...secretDoc.data().reactions };
                    newReactions[emotionLabel] = (newReactions[emotionLabel] || 0) + 1;
                    transaction.update(docRef, { reactions: newReactions });
                });
                showToast('Reaction added!', 'success');
            } catch (error) {
                console.error("Transaction failed: ", error);
                showToast('Failed to add reaction. Please try again.', 'error');
            }
        };

        // Function to set up the Firestore listener for real-time updates
        const startRealtimeListener = () => {
            if (!db) {
                console.error('Firestore not initialized.');
                return;
            }

            // Listen for all secrets and sort them client-side
            const q = query(collection(db, collectionPath));
            
            onSnapshot(q, (snapshot) => {
                const secrets = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate().getTime() || Date.now()
                }));
                // Sort the secrets by timestamp in descending order in the client
                secrets.sort((a, b) => b.timestamp - a.timestamp);
                renderSecrets(secrets);
            });
        };
        
        // --- Event Listeners ---
        const addListeners = () => {
            confessForm.addEventListener('submit', handleConfess);
            secretsContainer.addEventListener('click', handleReaction);
            secretInput.addEventListener('input', (e) => {
                charCounterElement.textContent = `${e.target.value.length}/500`;
            });
            showThoughtButton.addEventListener('click', () => {
                const randomIndex = Math.floor(Math.random() * positiveThoughts.length);
                thoughtTextElement.textContent = positiveThoughts[randomIndex];
                positiveThoughtModal.classList.remove('hidden');
            });
            closeModalButton.addEventListener('click', () => {
                positiveThoughtModal.classList.add('hidden');
            });
        };

        // --- Start the app ---
        const setupFirebase = async () => {
            confessButton.disabled = true;
            loadingStateElement.classList.remove('hidden');
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        startRealtimeListener();
                        addListeners();
                        confessButton.disabled = false;
                        loadingStateElement.classList.add('hidden');
                        showToast('Connected to Firebase successfully!', 'success');
                    } else {
                        console.error('Authentication failed.');
                        showToast('Authentication failed. Please try again.', 'error');
                        confessButton.disabled = true;
                        loadingStateElement.textContent = 'Failed to connect.';
                    }
                });
            } catch (error) {
                console.error("Error during Firebase setup:", error);
                showToast('App failed to initialize. Please check console.', 'error');
                confessButton.disabled = true;
                loadingStateElement.textContent = 'Failed to connect.';
            }
        };

        setupFirebase();
    </script>
</body>
</html>
